# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

default_platform(:ios)

platform :ios do
  desc "Load App Store Connect API Key"
  lane :load_api_key do
    if ENV["APP_STORE_CONNECT_API_KEY_ID"] && ENV["APP_STORE_CONNECT_API_ISSUER_ID"] && ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
      app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
        is_key_content_base64: true,
        in_house: false
      )
    end
  end

  desc "Setup code signing for CI"
  lane :setup_signing do |options|
    if ENV["CI"]
      setup_ci

      # Create a temporary keychain for CI
      keychain_name = "fastlane_keychain"
      keychain_password = SecureRandom.base64(24)

      create_keychain(
        name: keychain_name,
        password: keychain_password,
        default_keychain: true,
        unlock: true,
        timeout: 3600,
        lock_when_sleeps: false
      )

      # Import distribution certificate
      if ENV["IOS_DISTRIBUTION_CERTIFICATE_BASE64"]
        certificate_path = "#{Dir.tmpdir}/distribution.p12"
        File.write(certificate_path, Base64.decode64(ENV["IOS_DISTRIBUTION_CERTIFICATE_BASE64"]))

        import_certificate(
          certificate_path: certificate_path,
          certificate_password: ENV["IOS_DISTRIBUTION_CERTIFICATE_PASSWORD"] || "",
          keychain_name: keychain_name,
          keychain_password: keychain_password
        )
      end

      # Install provisioning profile
      if ENV["IOS_PROVISIONING_PROFILE_BASE64"]
        profile_path = "#{Dir.tmpdir}/profile.mobileprovision"
        File.write(profile_path, Base64.decode64(ENV["IOS_PROVISIONING_PROFILE_BASE64"]))

        install_provisioning_profile(path: profile_path)

        # Extract profile name for later use
        profile_info = `security cms -D -i "#{profile_path}" 2>/dev/null`
        if profile_info.include?("<key>Name</key>")
          profile_name = profile_info.match(/<key>Name<\/key>\s*<string>([^<]+)<\/string>/)[1]
          ENV["PROVISIONING_PROFILE_NAME"] = profile_name
        end
      end
    end
  end

  desc "Install CocoaPods dependencies"
  lane :install_pods do
    cocoapods(
      podfile: "./Podfile",
      try_repo_update_on_error: true
    )
  end

  desc "Build debug build"
  lane :build_debug do
    install_pods
    build_app(
      workspace: "App.xcworkspace",
      scheme: "App",
      configuration: "Debug",
      export_method: "development",
      skip_codesigning: true,
      skip_archive: true,
      destination: "generic/platform=iOS Simulator"
    )
  end

  desc "Build release IPA for App Store"
  lane :build_release do |options|
    load_api_key
    setup_signing(type: "appstore")
    install_pods

    # Increment build number if specified
    if options[:build_number]
      increment_build_number(
        build_number: options[:build_number],
        xcodeproj: "App.xcodeproj"
      )
    end

    export_options = {}
    if ENV["PROVISIONING_PROFILE_NAME"]
      export_options[:provisioningProfiles] = {
        "app.trizum.capacitor" => ENV["PROVISIONING_PROFILE_NAME"]
      }
    end

    # Configure manual signing for CI builds
    build_settings = {}
    if ENV["CI"] && ENV["PROVISIONING_PROFILE_NAME"]
      build_settings = {
        "CODE_SIGN_STYLE" => "Manual",
        "CODE_SIGN_IDENTITY" => "Apple Distribution",
        "PROVISIONING_PROFILE_SPECIFIER" => ENV["PROVISIONING_PROFILE_NAME"]
      }
    end

    build_app(
      workspace: "App.xcworkspace",
      scheme: "App",
      configuration: "Release",
      export_method: "app-store",
      export_options: export_options.empty? ? nil : export_options,
      xcargs: build_settings.map { |k, v| "#{k}='#{v}'" }.join(" ")
    )
  end

  desc "Build release IPA for Ad Hoc distribution"
  lane :build_adhoc do |options|
    load_api_key
    setup_signing(type: "adhoc")
    install_pods

    # Increment build number if specified
    if options[:build_number]
      increment_build_number(
        build_number: options[:build_number],
        xcodeproj: "App.xcodeproj"
      )
    end

    export_options = {}
    if ENV["PROVISIONING_PROFILE_NAME"]
      export_options[:provisioningProfiles] = {
        "app.trizum.capacitor" => ENV["PROVISIONING_PROFILE_NAME"]
      }
    end

    # Configure manual signing for CI builds
    build_settings = {}
    if ENV["CI"] && ENV["PROVISIONING_PROFILE_NAME"]
      build_settings = {
        "CODE_SIGN_STYLE" => "Manual",
        "CODE_SIGN_IDENTITY" => "Apple Distribution",
        "PROVISIONING_PROFILE_SPECIFIER" => ENV["PROVISIONING_PROFILE_NAME"]
      }
    end

    build_app(
      workspace: "App.xcworkspace",
      scheme: "App",
      configuration: "Release",
      export_method: "ad-hoc",
      export_options: export_options.empty? ? nil : export_options,
      xcargs: build_settings.map { |k, v| "#{k}='#{v}'" }.join(" ")
    )
  end

  desc "Upload to TestFlight"
  lane :deploy_testflight do |options|
    build_release(build_number: options[:build_number])
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
  end

  desc "Upload to App Store (binary only, no metadata)"
  lane :deploy_appstore do |options|
    build_release(build_number: options[:build_number])
    upload_to_app_store(
      submit_for_review: false,
      automatic_release: false,
      skip_screenshots: true,
      skip_metadata: true
    )
  end

  # ============================================
  # Metadata Management Lanes
  # ============================================

  desc "Download existing metadata from App Store Connect"
  lane :download_metadata do
    load_api_key
    deliver(
      app_identifier: "app.trizum.capacitor",
      skip_binary_upload: true,
      skip_screenshots: false,
      force: true,
      run_precheck_before_submit: false
    )
  end

  desc "Upload metadata only (no build)"
  lane :upload_metadata do
    load_api_key
    deliver(
      app_identifier: "app.trizum.capacitor",
      skip_binary_upload: true,
      skip_screenshots: true,
      force: true,
      run_precheck_before_submit: true,
      precheck_include_in_app_purchases: false
    )
  end

  desc "Upload screenshots only"
  lane :upload_screenshots do
    load_api_key
    deliver(
      app_identifier: "app.trizum.capacitor",
      skip_binary_upload: true,
      skip_metadata: true,
      skip_screenshots: false,
      force: true,
      overwrite_screenshots: true
    )
  end

  # ============================================
  # Full Deployment Lanes
  # ============================================

  desc "Full App Store deployment with metadata"
  desc "Options: build_number, skip_screenshots (default: true), submit_for_review (default: false), automatic_release (default: false)"
  lane :deploy_appstore_full do |options|
    build_release(build_number: options[:build_number])

    deliver(
      app_identifier: "app.trizum.capacitor",
      skip_screenshots: options[:skip_screenshots].nil? ? true : options[:skip_screenshots],
      skip_metadata: false,
      force: true,
      submit_for_review: options[:submit_for_review] || false,
      automatic_release: options[:automatic_release] || false,
      phased_release: true,
      run_precheck_before_submit: true,
      precheck_include_in_app_purchases: false,
      submission_information: {
        add_id_info_uses_idfa: false,
        export_compliance_uses_encryption: false,
        export_compliance_is_exempt: true,
        content_rights_contains_third_party_content: false,
        content_rights_has_rights: true
      }
    )
  end

  desc "Deploy to TestFlight with metadata update"
  lane :deploy_testflight_full do |options|
    build_release(build_number: options[:build_number])

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: options[:wait_for_processing] ? false : true
    )

    # Also update App Store metadata (won't affect TestFlight)
    deliver(
      app_identifier: "app.trizum.capacitor",
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      force: true,
      run_precheck_before_submit: false
    )
  end

  desc "Submit existing build for App Store review"
  desc "Use this after uploading a build to submit it for review"
  lane :submit_review do |options|
    load_api_key
    deliver(
      app_identifier: "app.trizum.capacitor",
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: true,
      submit_for_review: true,
      automatic_release: options[:automatic_release] || false,
      phased_release: true,
      run_precheck_before_submit: true,
      submission_information: {
        add_id_info_uses_idfa: false,
        export_compliance_uses_encryption: false,
        export_compliance_is_exempt: true,
        content_rights_contains_third_party_content: false,
        content_rights_has_rights: true
      }
    )
  end

  # ============================================
  # Utility Lanes
  # ============================================

  desc "Increment version number"
  desc "Options: bump_type (major, minor, patch)"
  lane :bump_version do |options|
    bump_type = options[:bump_type] || "patch"
    increment_version_number(
      bump_type: bump_type,
      xcodeproj: "App.xcodeproj"
    )
  end

  desc "Set specific version number"
  lane :set_version do |options|
    if options[:version]
      increment_version_number(
        version_number: options[:version],
        xcodeproj: "App.xcodeproj"
      )
    else
      UI.user_error!("Please provide a version number: fastlane set_version version:1.2.3")
    end
  end

  desc "Print current version and build number"
  lane :current_version do
    version = get_version_number(xcodeproj: "App.xcodeproj")
    build = get_build_number(xcodeproj: "App.xcodeproj")
    UI.success("Current version: #{version} (#{build})")
  end
end
